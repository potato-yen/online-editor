version: '3.8'

services:
  # 後端服務 (Tectonic + Node Server)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: online-editor-backend
    ports:
      - "3001:3001"
    volumes:
      # 掛載程式碼，這樣修改 server.js 會自動重啟 (如果有用 nodemon)
      # 即使沒用 nodemon，這對保持程式碼同步也有用
      - ./backend:/app/backend
      # 建立一個匿名 volume 來 "保護" 容器內的 node_modules
      # 避免被本地端的 node_modules 覆蓋
      - /app/backend/node_modules
    networks:
      - editor-net

  # 前端服務 (Vite Dev Server)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: online-editor-frontend
    ports:
      - "5173:5173"
    volumes:
      # 掛載程式碼，這樣修改 React 組件會觸發 HMR (熱更新)
      - ./frontend:/app/frontend
      # 同樣保護 node_modules
      - /app/frontend/node_modules
    environment:
      # 這裡會讀取您本機的 .env 檔案
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
      # 關鍵：
      # 覆寫我們在步驟 1 新增的變數
      # 'backend' 是此 docker-compose 檔案中定義的服務名稱
      # Docker 的內部 DNS 會將 'backend' 解析到後端容器的 IP
      VITE_BACKEND_URL: http://backend:3001/compile-latex
    networks:
      - editor-net
    # 確保後端服務先啟動
    depends_on:
      - backend

# 定義一個共用網路，讓 frontend 和 backend 可以互相溝通
networks:
  editor-net:
    driver: bridge
